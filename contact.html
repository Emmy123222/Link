<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VUNO - Premium Video Calling</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            'background-dark': '#0f172a',
            'surface-dark': '#1e293b',
            'surface-light': '#f1f5f9',
          }
        }
      }
    }
  </script>
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .video-container {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .control-btn {
      transition: all 0.2s ease;
    }
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .control-btn:active {
      transform: scale(0.95);
    }
    .participant-grid {
      display: grid;
      gap: 16px;
      padding: 16px;
      height: 100%;
      width: 100%;
    }
    .participant-tile {
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      background: rgba(30, 41, 59, 0.5);
    }
    .participant-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .floating-controls {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
    }
    .participant-info {
      position: absolute;
      bottom: 12px;
      left: 12px;
      padding: 6px 12px;
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pip-video {
      transition: all 0.3s ease;
    }
    .pip-video:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .call-status {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 40;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .video-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      background: rgba(14, 165, 233, 0.2);
    }
    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .grid-3 .participant-tile:last-child { grid-column: span 2; }
    .grid-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .grid-5 { 
      grid-template-columns: repeat(3, 1fr); 
      grid-template-rows: repeat(2, 1fr); 
    }
    .grid-5 .participant-tile:last-child { grid-column: span 2; }
    .grid-6 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); }
    .grid-many {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      grid-auto-rows: minmax(200px, auto);
    }
    .active-speaker {
      border: 2px solid #0ea5e9;
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.4);
    }
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 60;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
  </style>
</head>
<body class="h-full bg-background-dark text-white overflow-hidden">
<div id="my-video-container" class="video-container w-full h-full bg-gray-900">
  <!-- Participant Grid -->
  <div id="participant-grid" class="participant-grid grid grid-cols-1 gap-0 w-full h-full">
    
    <!-- Local Video - Initially full screen when alone -->
    <div id="local-video-container" class="participant-tile relative w-full h-full bg-gray-800">
      
      <!-- Local Video -->
      <video id="my-video-preview" autoplay muted playsinline class="w-full h-full object-cover"></video>
      
      <!-- Profile Avatar (hidden at first) -->
      <img id="profile-avatar" src="avatar.jpg" alt="Profile Avatar"
           class="hidden absolute inset-0 m-auto w-24 h-24 rounded-full object-cover">
      
      <!-- Info Bar -->
      <div class="participant-info absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3 text-white text-sm flex items-center justify-between">
        <span>You</span>
        <i class="fas fa-volume-mute text-red-400 hidden" id="mic-muted-indicator"></i>
      </div>
      
    </div>
  </div>

  <!-- Call Status Bar -->
  <div class="call-status glass-effect px-4 py-2 rounded-full flex items-center space-x-2 fade-in absolute top-4 left-1/2 transform -translate-x-1/2">
    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
    <span class="text-sm font-medium" id="call-status-text">Connecting...</span>
  </div>

  <!-- Floating Controls -->
  <div class="floating-controls glass-effect px-6 py-3 rounded-2xl flex items-center space-x-4 absolute bottom-8 left-1/2 transform -translate-x-1/2">
    <!-- Microphone Button -->
    <button id="mic-toggle" class="control-btn w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20">
      <i id="mic-icon" class="fas fa-microphone text-xl"></i>
    </button>

    <!-- Camera Button -->
    <button id="camera-toggle" class="control-btn w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20">
      <i id="camera-icon" class="fas fa-video text-xl"></i>
    </button>
    
    <!-- Screen Share Button -->
    <button id="screenshare-toggle" class="control-btn w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20">
      <i class="fas fa-desktop text-xl"></i>
    </button>
    
    <!-- Participants Button -->
    <button id="participants-toggle" class="control-btn w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white-20 relative">
      <i class="fas fa-users text-xl"></i>
      <span id="participant-count" class="absolute -top-2 -right-2 bg-primary-600 text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </button>
    
    <!-- More Options -->
    <div class="relative">
      <button id="more-options" class="control-btn w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20">
        <i class="fas fa-ellipsis-h text-xl"></i>
      </button>
    </div>
    
    <!-- End Call Button -->
    <button id="end-call" class="control-btn w-14 h-14 rounded-full bg-red-600 flex items-center justify-center text-white hover:bg-red-700">
      <i class="fas fa-phone text-xl transform rotate-135"></i>
    </button>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification absolute top-20 left-1/2 transform -translate-x-1/2">
    <div class="flex items-center">
      <i class="fas fa-info-circle text-primary-400 mr-2"></i>
      <span id="notification-text"></span>
    </div>
  </div>
</div>

 <script>
  // DOM Elements
  const myVideoPreview = document.getElementById('my-video-preview');
  const participantGrid = document.getElementById('participant-grid');
  const callStatusText = document.getElementById('call-status-text');

  // State
  let localStream = null;
  let pc = null;
  let ws = null;

  async function startMyVideo() {
    try {
      // 🔹 Get media
      localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: 1280, height: 720 },
        audio: true
      });
      myVideoPreview.srcObject = localStream;

      callStatusText.textContent = 'Connected';
      document.querySelector('.call-status .w-3').classList.remove('bg-red-500');
      document.querySelector('.call-status .w-3').classList.add('bg-green-500');

      // 🔹 Setup signaling
      const meetingId = new URLSearchParams(window.location.search).get("meeting");
      ws = new WebSocket(`ws://vuno-1.onrender.com/ws/call/${meetingId}/`);

      // 🔹 Create PeerConnection
      pc = new RTCPeerConnection();

      // Add local tracks
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // ICE candidates → send to WS
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
      };

      // Remote track → show video
      pc.ontrack = (event) => {
        const remoteVideo = document.createElement("video");
        remoteVideo.autoplay = true;
        remoteVideo.playsInline = true;
        remoteVideo.srcObject = event.streams[0];

        const remoteContainer = document.createElement("div");
        remoteContainer.className = "participant-tile fade-in";
        remoteContainer.appendChild(remoteVideo);

        participantGrid.appendChild(remoteContainer);
      };

      // --- Signaling logic ---
      ws.onopen = async () => {
        console.log("✅ WebSocket connected");

        // Create and send offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({ type: "offer", offer: offer }));
      };

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === "offer") {
          console.log("📩 Received offer");
          await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));

          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          ws.send(JSON.stringify({ type: "answer", answer: answer }));
        }

        else if (msg.type === "answer") {
          console.log("📩 Received answer");
          await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }

        else if (msg.type === "candidate" && msg.candidate) {
          console.log("📩 Received ICE candidate");
          try {
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          } catch (err) {
            console.error("Error adding ICE candidate:", err);
          }
        }
      };
    } catch (err) {
      console.error("❌ Failed to access media devices:", err);
      alert("Could not access camera/microphone.");
    }
  }

  // Start video on load
  document.addEventListener("DOMContentLoaded", startMyVideo);
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const micBtn = document.getElementById("mic-toggle");
  const micIcon = document.getElementById("mic-icon");
  const videoEl = document.getElementById("my-video-preview"); // same video element
  let micOn = true;

  micBtn.addEventListener("click", () => {
    micOn = !micOn;

    if (micOn) {
      // 🎤 Mic ON
      micIcon.className = "fas fa-microphone text-xl";
      micBtn.classList.remove("bg-red-500", "hover:bg-red-600");
      micBtn.classList.add("bg-white/10", "hover:bg-white/20");

      // Resume audio track
      if (videoEl.srcObject) {
        videoEl.srcObject.getAudioTracks().forEach(track => (track.enabled = true));
      }
    } else {
      // 🔇 Mic OFF
      micIcon.className = "fas fa-microphone-slash text-xl";
      micBtn.classList.remove("bg-white/10", "hover:bg-white/20");
      micBtn.classList.add("bg-red-500", "hover:bg-red-600");

      // Mute audio track
      if (videoEl.srcObject) {
        videoEl.srcObject.getAudioTracks().forEach(track => (track.enabled = false));
      }
    }

    console.log("Microphone is now:", micOn ? "ON" : "OFF");
  });
});
</script>



<!-- video -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const cameraBtn = document.getElementById("camera-toggle");
  const cameraIcon = document.getElementById("camera-icon");
  const videoEl = document.getElementById("my-video-preview"); // ✅ fixed ID
  const avatarEl = document.getElementById("profile-avatar");
  let cameraOn = true;

  cameraBtn.addEventListener("click", () => {
    cameraOn = !cameraOn;

    if (cameraOn) {
      // 📹 Camera ON
      cameraIcon.className = "fas fa-video text-xl";
      cameraBtn.classList.remove("bg-red-500", "hover:bg-red-600");
      cameraBtn.classList.add("bg-white/10", "hover:bg-white/20");

      // Show video, hide avatar
      videoEl.classList.remove("hidden");
      avatarEl.classList.add("hidden");

      // Resume video stream
      if (videoEl.srcObject) {
        videoEl.srcObject.getVideoTracks().forEach(track => (track.enabled = true));
      }
    } else {
      // 🚫 Camera OFF
      cameraIcon.className = "fas fa-video-slash text-xl";
      cameraBtn.classList.remove("bg-white/10", "hover:bg-white/20");
      cameraBtn.classList.add("bg-red-500", "hover:bg-red-600");

      // Hide video, show avatar
      videoEl.classList.add("hidden");
      avatarEl.classList.remove("hidden");

      // Pause video stream
      if (videoEl.srcObject) {
        videoEl.srcObject.getVideoTracks().forEach(track => (track.enabled = false));
      }
    }

    console.log("Camera is now:", cameraOn ? "ON" : "OFF");
  });
});
</script>

<!-- share screen -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const screenShareBtn = document.getElementById("screenshare-toggle");
  const videoEl = document.getElementById("my-video-preview");
  let screenStream = null;
  let originalStream = null;
  let sharingScreen = false;

  // Save the original cam stream when available
  async function initCamera() {
    try {
      originalStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      videoEl.srcObject = originalStream;
    } catch (err) {
      console.error("❌ Error accessing camera:", err);
    }
  }

  // Call on load
  initCamera();

  screenShareBtn.addEventListener("click", async () => {
    if (!sharingScreen) {
      try {
        // 🖥️ Start Screen Share
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        sharingScreen = true;

        // Replace video with screen stream
        videoEl.srcObject = screenStream;

        // If user stops sharing manually (via browser UI), revert back
        screenStream.getVideoTracks()[0].addEventListener("ended", () => {
          stopScreenShare();
        });

        // Update button style
        screenShareBtn.classList.remove("bg-white/10", "hover:bg-white/20");
        screenShareBtn.classList.add("bg-green-500", "hover:bg-green-600");

        console.log("✅ Screen sharing started");
      } catch (err) {
        console.error("❌ Screen share failed:", err);
      }
    } else {
      // 🛑 Stop Screen Share
      stopScreenShare();
    }
  });

  function stopScreenShare() {
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      screenStream = null;
    }
    sharingScreen = false;

    // Restore camera stream if available
    if (originalStream) {
      videoEl.srcObject = originalStream;
    }

    // Reset button style
    screenShareBtn.classList.remove("bg-green-500", "hover:bg-green-600");
    screenShareBtn.classList.add("bg-white/10", "hover:bg-white/20");

    console.log("🛑 Screen sharing stopped, back to camera");
  }
});
</script>
<!-- end call -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const endCallBtn = document.getElementById("end-call");
  const videoEl = document.getElementById("my-video-preview");

  endCallBtn.addEventListener("click", () => {
    // 🛑 Stop all media tracks (camera, mic, screen share)
    if (videoEl.srcObject) {
      videoEl.srcObject.getTracks().forEach(track => track.stop());
      videoEl.srcObject = null;
    }

    // 👉 If using WebRTC, also close peer connections here
    // Example:
    // if (peerConnection) {
    //   peerConnection.close();
    //   peerConnection = null;
    // }

    console.log("📞 Call ended");

    // 🔙 Redirect to home page
    window.location.href = "index.html";
  });
});
</script>
<!-- participant -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const participantsBtn = document.getElementById("participants-toggle");
  const participantCountEl = document.getElementById("participant-count");

  let participants = []; // store real users

  // Create floating participant panel
  const panel = document.createElement("div");
  panel.id = "participants-panel";
  panel.className =
    "hidden absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white rounded-xl shadow-lg p-4 w-64 max-h-80 overflow-y-auto z-50";
  document.body.appendChild(panel);

  participantsBtn.addEventListener("click", () => {
    panel.classList.toggle("hidden");
  });

  // ✅ Update participant UI
  function updateParticipantsUI() {
    const count = participants.length;
    if (count > 0) {
      participantCountEl.textContent = count;
      participantCountEl.classList.remove("hidden");
    } else {
      participantCountEl.classList.add("hidden");
    }

    panel.innerHTML = `
      <h3 class="text-lg font-semibold mb-3">Participants (${count})</h3>
      <ul class="space-y-2">
        ${participants
          .map(
            (p) => `
          <li class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-user"></i>
            </div>
            <span>${p.name || "Guest"}</span>
          </li>
        `
          )
          .join("")}
      </ul>
    `;
  }

  // 👉 Add/remove participants
  function addParticipant(user) {
    if (!participants.find((p) => p.id === user.id)) {
      participants.push(user);
      updateParticipantsUI();
    }
  }

  function removeParticipant(userId) {
    participants = participants.filter((p) => p.id !== userId);
    updateParticipantsUI();
  }

  // ✅ Real-time signaling connection (replace with your server)
  const roomId = "demo-room-123"; // get dynamically in real app
  const username = "You"; // replace with logged-in user's name
  const socket = new WebSocket(`wss://your-server.com/ws/room/${roomId}/`);

  socket.onopen = () => {
    console.log("✅ Connected to signaling server");
    // announce yourself
    socket.send(JSON.stringify({ type: "join", id: Date.now().toString(), name: username }));
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "join") {
      addParticipant({ id: data.id, name: data.name });
    } else if (data.type === "leave") {
      removeParticipant(data.id);
    } else if (data.type === "current-users") {
      // server sends full list when you connect
      participants = data.users;
      updateParticipantsUI();
    }
  };

  socket.onclose = () => {
    console.log("❌ Disconnected from signaling server");
  };

  // 👉 Notify server when leaving
  window.addEventListener("beforeunload", () => {
    socket.send(JSON.stringify({ type: "leave", id: Date.now().toString() }));
    socket.close();
  });
});
</script>

</body>
</html>